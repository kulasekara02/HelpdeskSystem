@page "/dashboard"
@attribute [Authorize]
@inject IDashboardService DashboardService
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Dashboard - Helpdesk System</PageTitle>

<h3 class="mb-4">
    <i class="bi bi-graph-up me-2"></i>Analytics Dashboard
</h3>

@if (_isLoading)
{
    <div class="d-flex justify-content-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (_dashboard != null)
{
    <!-- KPI Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1 opacity-75">Total Tickets</h6>
                            <h2 class="mb-0 fw-bold">@_dashboard.TotalTickets</h2>
                        </div>
                        <i class="bi bi-ticket-detailed fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1 opacity-75">Open Tickets</h6>
                            <h2 class="mb-0 fw-bold">@_dashboard.OpenTickets</h2>
                        </div>
                        <i class="bi bi-folder2-open fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1 opacity-75">In Progress</h6>
                            <h2 class="mb-0 fw-bold">@_dashboard.InProgressTickets</h2>
                        </div>
                        <i class="bi bi-hourglass-split fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1 opacity-75">Avg Resolution</h6>
                            <h2 class="mb-0 fw-bold">@_dashboard.AverageResolutionHours<small class="fs-6">hrs</small></h2>
                        </div>
                        <i class="bi bi-clock-history fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart me-2"></i>Tickets by Status
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up-arrow me-2"></i>Tickets Per Day (Last 14 Days)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="dailyChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Summary Table -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-table me-2"></i>Status Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Status</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var status in _dashboard.TicketsByStatus)
                                {
                                    var percentage = _dashboard.TotalTickets > 0
                                        ? (double)status.Count / _dashboard.TotalTickets * 100
                                        : 0;
                                    var colorClass = status.Status switch
                                    {
                                        "Open" => "warning",
                                        "InProgress" => "info",
                                        "Resolved" => "success",
                                        "Closed" => "secondary",
                                        _ => "primary"
                                    };
                                    <tr>
                                        <td>
                                            <span class="badge bg-@colorClass">@status.Status</span>
                                        </td>
                                        <td>@status.Count</td>
                                        <td>@percentage.ToString("F1")%</td>
                                        <td style="width: 40%;">
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-@colorClass"
                                                     role="progressbar"
                                                     style="width: @percentage%"
                                                     aria-valuenow="@percentage"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private DashboardDto? _dashboard;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        _dashboard = await DashboardService.GetDashboardDataAsync();
        _isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _dashboard != null)
        {
            await RenderChartsAsync();
        }
    }

    private async Task RenderChartsAsync()
    {
        var statusLabels = _dashboard!.TicketsByStatus.Select(s => s.Status).ToArray();
        var statusData = _dashboard.TicketsByStatus.Select(s => s.Count).ToArray();
        var statusColors = new[] { "#ffc107", "#17a2b8", "#28a745", "#6c757d" };

        await JS.InvokeVoidAsync("renderPieChart", "statusChart", statusLabels, statusData, statusColors);

        var dailyLabels = _dashboard.TicketsPerDay.Select(d => d.Date.ToString("MM/dd")).ToArray();
        var dailyData = _dashboard.TicketsPerDay.Select(d => d.Count).ToArray();

        await JS.InvokeVoidAsync("renderLineChart", "dailyChart", dailyLabels, dailyData);
    }
}
