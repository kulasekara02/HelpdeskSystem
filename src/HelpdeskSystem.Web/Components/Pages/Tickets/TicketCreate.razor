@page "/tickets/create"
@attribute [Authorize]
@inject ITicketService TicketService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<PageTitle>Create Ticket - Helpdesk System</PageTitle>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h4 class="mb-0">
                    <i class="bi bi-plus-circle me-2"></i>Create New Ticket
                </h4>
            </div>
            <div class="card-body">
                <EditForm Model="_model" OnValidSubmit="HandleSubmitAsync" FormName="createTicket">
                    <DataAnnotationsValidator />

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Title <span class="text-danger">*</span></label>
                        <InputText @bind-Value="_model.Title" class="form-control" placeholder="Brief description of the issue" />
                        <ValidationMessage For="() => _model.Title" class="text-danger small" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Description <span class="text-danger">*</span></label>
                        <InputTextArea @bind-Value="_model.Description" class="form-control" rows="6"
                                       placeholder="Provide detailed information about the issue..." />
                        <ValidationMessage For="() => _model.Description" class="text-danger small" />
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-semibold">Priority</label>
                        <InputSelect @bind-Value="_model.Priority" class="form-select">
                            @foreach (var priority in Enum.GetValues<TicketPriority>())
                            {
                                <option value="@priority">@priority</option>
                            }
                        </InputSelect>
                    </div>

                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>@_errorMessage
                        </div>
                    }

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" disabled="@_isSubmitting">
                            @if (_isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            <i class="bi bi-check-circle me-2"></i>Create Ticket
                        </button>
                        <a href="tickets" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </a>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private CreateTicketDto _model = new() { Priority = TicketPriority.Medium };
    private bool _isSubmitting = false;
    private string? _errorMessage;

    private async Task HandleSubmitAsync()
    {
        if (string.IsNullOrWhiteSpace(_model.Title) || string.IsNullOrWhiteSpace(_model.Description))
        {
            _errorMessage = "Title and Description are required.";
            return;
        }

        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                _errorMessage = "User not authenticated.";
                return;
            }

            var ticket = await TicketService.CreateTicketAsync(_model, userId);
            Navigation.NavigateTo($"tickets/{ticket.Id}");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error creating ticket: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
